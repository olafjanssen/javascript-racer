/**
 * name: 07-interval-temp
 *
 * Full control agent: takes its x position on the road and its own speed as input and allows left, neutral and right with full throttle, neutral and braking.
 * Reward is speed of car.
 *
 * Bigger brain to compensate for more output nodes.
 *
 * Only is active every 6 frames, which means action and reward is taken across 100ms.
 */

var Agent = function (environment) {
    var tick = 0;
    var episode = 0;
    var maxEpisodes = 20;
    var stats = [];
    var interval = 6;
    var temp_rate = 0.75;

    var spec = {
        update: 'qlearn', // qlearn | sarsa
        gamma: 0.9, // discount factor, [0, 1)
        epsilon: 0, // initial epsilon for epsilon-greedy policy, [0, 1)
        alpha: 0, //0.005; // value function learning rate
        experience_add_every: 5, // number of time steps before we add another experience to replay memory
        experience_size: 10000, // size of experience
        learning_steps_per_iteration: 5,
        tderror_clamp: 1.0, // for robustness
        num_hidden_units: 40 // number of neurons in hidden layer
    };

    var agent = new RL.DQNAgent(environment, spec); // give agent a TD brain
    agent.fromJSON({"nh":40,"ns":2,"na":9,"net":{"W1":{"n":40,"d":2,"w":{"0":0.039951723528920915,"1":-0.04674953148661358,"2":0.15874854627426727,"3":-0.15315910496459553,"4":-0.0006235965913836861,"5":0.0007316281622215514,"6":-0.013434662268368956,"7":0.015757360322087695,"8":-4.000690358069796,"9":-3.7275633663727974,"10":0.045007571412135086,"11":-0.052630190029096295,"12":1.0251353344597258,"13":-5.205572316935036,"14":0.027539140261830942,"15":-0.03226828082451416,"16":0.008648611860946332,"17":-0.010145735399953044,"18":0.005846574824016261,"19":-0.006859130448887284,"20":-0.002824769249266644,"21":0.003314144729912952,"22":-0.012979937377870468,"23":0.015224338002018402,"24":-0.08378882029423028,"25":0.09734685723131195,"26":-0.6084072405045738,"27":0.4034031039924811,"28":-0.44173986409264254,"29":0.8179812303720558,"30":-0.017254651996196697,"31":0.020233683785492375,"32":-0.013720123615809265,"33":0.01609195823061835,"34":5.453161590852179,"35":-3.332686847621442,"36":-0.04485293966563638,"37":0.05244969661337656,"38":0.06942011374796615,"39":-0.08086610277557041,"40":0.011480704339904365,"41":-0.013466725106441731,"42":-0.1892790526368873,"43":0.20865331230363682,"44":-0.005766481259845026,"45":0.006765176707061456,"46":3.4071718740204378,"47":0.485105318815747,"48":-0.03738608408045761,"49":0.04376113525897939,"50":-0.008690488195786321,"51":0.010194837335106526,"52":-0.2405763205295241,"53":0.27369606107658007,"54":-0.006849977859215786,"55":0.008036137942117619,"56":4.397708480281096,"57":0.44076716115611136,"58":-0.026429445349798537,"59":0.030971467697648785,"60":-0.0040220813978549645,"61":0.004718806058927472,"62":0.004352441690752878,"63":-0.005106368182084391,"64":-0.12661006894665713,"65":0.13745326897610663,"66":0.11245086692004215,"67":-0.12998339991195967,"68":-0.003483802487905522,"69":0.004087312837971469,"70":-0.21661838085724933,"71":0.23573394008698634,"72":-0.2837201060704563,"73":0.2979502889331599,"74":0.0047342264619639135,"75":-0.0055542517667354985,"76":-0.21192238764771876,"77":0.19565753384909457,"78":0.004140499437136371,"79":-0.004857728845681404}},"b1":{"n":40,"d":1,"w":{"0":0.006869416603816391,"1":0.01581694485875723,"2":-0.00010781596108800079,"3":-0.002321314109188295,"4":2.781186640455894,"5":0.007727961516218329,"6":3.832987052163908,"7":0.004748412517750774,"8":0.001494939728770942,"9":0.0010107481790630015,"10":-0.0004883926696076084,"11":-0.002242843704246446,"12":-0.014204010841683427,"13":-0.009759173011959513,"14":-0.16561832578960753,"15":-0.002980078895597211,"16":-0.0023705703514480207,"17":-2.2694905178645386,"18":-0.007701456609501753,"19":0.01182819856594295,"20":0.0019840532457486284,"21":-0.028655839683150504,"22":-0.000996905156340531,"23":-0.7666224066068359,"24":-0.006432477644881993,"25":-0.0015021702712974215,"26":-0.0401025665818466,"27":-0.0011841617140716859,"28":2.3008889564677735,"29":-0.0045581578641082,"30":-0.0006953786476310865,"31":0.000752486986110422,"32":-0.018068079657833608,"33":0.018895587190056032,"34":-0.0006023245191584244,"35":-0.03199151843986708,"36":-0.0391957326464884,"37":0.0008184826901637074,"38":-0.018486066117903596,"39":0.0007158494146606003}},"W2":{"n":9,"d":40,"w":{"0":-0.012947297874668046,"1":-0.049838564859583476,"2":0.0002022038602583509,"3":0.00435597123384199,"4":-1.5377316069128615,"5":-0.014583667099612932,"6":-1.1815653595655071,"7":-0.00892725877801456,"8":-0.0028042806358678017,"9":-0.0018957582743903373,"10":0.0009159436688553977,"11":0.0042085525348300795,"12":0.02711068002412647,"13":0.1776765404403062,"14":0.15663883356290165,"15":0.0055943033497189,"16":0.004448514909750964,"17":-2.364905873030085,"18":0.01453359166581267,"19":-0.022475010684094382,"20":-0.0037224980529360205,"21":0.06058863793587807,"22":0.0018697884872816086,"23":2.2220005750538627,"24":0.012116655428180714,"25":0.0028178576438413986,"26":0.0772715964584076,"27":0.0022211027475435817,"28":-2.2425028947413668,"29":0.008567730191615908,"30":0.0013041729030797956,"31":-0.0014112918637217975,"32":0.0404886000558618,"33":-0.03633892034435568,"34":0.0011296359009515065,"35":0.06913893927466966,"36":0.08981434232784448,"37":-0.0015350847392209723,"38":0.06603048042919199,"39":-0.0013425698608146713,"40":-0.006686405325850718,"41":-0.013714920297539379,"42":0.00010520394835577086,"43":0.002264446520586245,"44":-1.5570629675239427,"45":-0.007517069935495766,"46":-1.1438775305313844,"47":-0.00462790945001731,"48":-0.0014585574647862259,"49":-0.0009862119822209615,"50":0.00047655649278023187,"51":0.002187939526143495,"52":0.013711451919453927,"53":-0.03148412049835063,"54":0.16448576163937792,"55":0.002906541535426685,"56":0.002312468122659333,"57":-2.4611257216427,"58":0.007491427084714378,"59":-0.011456308824986824,"60":-0.001935594872563733,"61":0.026175907358513245,"62":0.0009727064156279452,"63":2.3668341723533612,"64":0.006263033218760113,"65":0.0014656100950764547,"66":0.03599678616438777,"67":0.0011553930578945847,"68":-2.446995018390475,"69":0.004442906285530328,"70":0.0006785172073531013,"71":-0.0007342376199013576,"72":0.016904060715963395,"73":-0.01808848340432753,"74":0.0005877231490870502,"75":0.028587438742054216,"76":0.0325460912158555,"77":-0.0007986284711123948,"78":0.014679985976805794,"79":-0.0006984905491693948,"80":-0.026480791096528088,"81":-0.10847684414968575,"82":0.0004131213338461689,"83":0.008900734371916677,"84":-1.4982310723298806,"85":-0.02983579859563459,"86":-1.1350328739052142,"87":-0.018248733148304476,"88":-0.005729674850029651,"89":-0.003873282752094792,"90":0.0018713569739392249,"91":0.008599435169563427,"92":0.05561470897026055,"93":0.4355544542059267,"94":0.2792854729316819,"95":0.01143200164268532,"96":0.009089881868363299,"97":-2.2405490223482323,"98":0.02973324805324079,"99":-0.046053566639146386,"100":-0.0076060736173519505,"101":0.1268235176017296,"102":0.0038202205622519933,"103":2.112276060237743,"104":0.024778721898747948,"105":0.005757420232285638,"106":0.16049344258143466,"107":0.004538043612181018,"108":-2.0289193354339887,"109":0.01751302377684042,"110":0.002664562409039005,"111":-0.0028834233424419905,"112":0.08500479680485659,"113":-0.07471625793481959,"114":0.0023079583725668213,"115":0.14547226682904343,"116":0.19170307894378688,"117":-0.0031363533446556635,"118":0.14568594078453714,"119":-0.0027430132963507173,"120":-0.02334018040721552,"121":-0.07820504843656972,"122":0.000365223567501465,"123":0.007866082394100792,"124":-1.4656798663193766,"125":-0.026277013060783633,"126":-1.4123324810039484,"127":-0.016109197122430047,"128":-0.00506470531431074,"129":-0.0034240341415280795,"130":0.0016543953293702417,"131":0.007599988733715123,"132":0.04861420859880993,"133":0.2124706763016456,"134":0.3680374223242196,"135":0.010100775091620728,"136":0.008033119660847911,"137":-2.0967480079137717,"138":0.026186916302224982,"139":-0.040380697602636496,"140":-0.0067225654213940046,"141":0.10457042147637757,"142":0.0033771327324399283,"143":1.9461210954200943,"144":0.021847855889272974,"145":0.005089217729036884,"146":0.13630159089136462,"147":0.004011593258909808,"148":-2.048097103928728,"149":0.01546169304468906,"150":0.0023555938133130528,"151":-0.0025490626930169493,"152":0.06915003713942901,"153":-0.06491363447177954,"154":0.0020403561814169554,"155":0.11821265879083162,"156":0.14965299014877842,"157":-0.0027726439035918177,"158":0.10038702200151689,"159":-0.0024249432844891576,"160":-0.023194948723484238,"161":-0.07606583432217692,"162":0.00036302234398276166,"163":0.007818499131157355,"164":-1.5624639384436292,"165":-0.026112215588239056,"166":-1.332802289878006,"167":-0.01601054873018738,"168":-0.005034138819181371,"169":-0.003403387404804042,"170":0.0016444255426908913,"171":0.007554027131273384,"172":0.048287940238064424,"173":0.19398658405318644,"174":0.38711964931229187,"175":0.010039520119803235,"176":0.007984517835939774,"177":-2.120011987107006,"178":0.026022683001249953,"179":-0.04011667352502746,"180":-0.006681942292546716,"181":0.10339072796823323,"182":0.003356769225135693,"183":1.9147935333332216,"184":0.021712414422127534,"185":0.005058502264662079,"186":0.13536090849485014,"187":0.003987397164944769,"188":-2.4170899932346086,"189":0.01536714283502058,"190":0.0023413953289135063,"191":-0.0025336971290538133,"192":0.06820048167482119,"193":-0.06445983528836967,"194":0.002028058903537235,"195":0.11674942347622011,"196":0.14731023618980083,"197":-0.0027559293437611682,"198":0.09712366062318378,"199":-0.0024103264833674394,"200":-0.026796984382604538,"201":-0.09486063778369967,"202":0.0004189783801745025,"203":0.009024661197497215,"204":-1.4915664279529843,"205":-0.030175002466156245,"206":-1.3389747283993456,"207":-0.01848745638436437,"208":-0.005810349367294121,"209":-0.003928049226647936,"210":0.0018978934297977298,"211":0.008719319769941853,"212":0.055939309695678466,"213":0.2927280158372176,"214":0.39559409795176254,"215":0.01158920891864596,"216":0.009216338605625856,"217":-2.075902504216085,"218":0.030071465566602843,"219":-0.04642634911989108,"220":-0.007712520205121709,"221":0.12222880321647309,"222":0.0038742420513403356,"223":1.86201716617474,"224":0.025081219840087238,"225":0.0058384744481636604,"226":0.1581818279268758,"227":0.00460212666126428,"228":-2.037184991077397,"229":0.017743765472423335,"230":0.002702309484124658,"231":-0.0029242590046187305,"232":0.08108962885324282,"233":-0.07482099877232723,"234":0.002340667556729371,"235":0.1387318476685334,"236":0.1776074819618171,"237":-0.003180754950230583,"238":0.12340740898654307,"239":-0.002781867804335951,"240":-0.006959640420844578,"241":-0.023013255816954632,"242":0.00010887971933575807,"243":0.0023450779924175675,"244":-1.2414350097662035,"245":-0.007835837000189852,"246":-1.9378011867287792,"247":-0.004802920411169412,"248":-0.001509896355311997,"249":-0.0010207720080848835,"250":0.0004932062861815277,"251":0.002265745266733126,"252":0.014509006228480194,"253":0.06426283780197761,"254":0.12974356718253857,"255":0.0030113420858131202,"256":0.0023948784157869253,"257":-1.7887800796484863,"258":0.007808943329157003,"259":-0.01204699362664214,"260":-0.0020041541343487003,"261":0.031309308868882675,"262":0.0010067896555292146,"263":1.4775061660090167,"264":0.006514471556586225,"265":0.001517204026103301,"266":0.04122400965855176,"267":0.0011959369818450468,"268":-1.958721054307315,"269":0.004609836087282835,"270":0.0007022472982444813,"271":-0.0007599243164359565,"272":0.02055500555185741,"273":-0.019395980338418464,"274":0.0006082686551106834,"275":0.03546107824133686,"276":0.0451605340166973,"277":-0.0008265785160327006,"278":0.02954000547082678,"279":-0.0007229217832814269,"280":-0.010776953188589811,"281":-0.03536295936092777,"282":0.0001686213930919325,"283":0.003631755579238168,"284":-1.2698421517399885,"285":-0.012133323315603604,"286":-1.8694612073586172,"287":-0.007437787425304458,"288":-0.002338354378048246,"289":-0.0015808600168194732,"290":0.0007638256862304124,"291":0.003508898791154129,"292":0.022458198866905678,"293":0.09423506100576975,"294":0.19293746182837854,"295":0.004663534117169597,"296":0.0037088776687175936,"297":-1.746673349281205,"298":0.012091687193232612,"299":-0.018650179636079883,"300":-0.003103789175462238,"301":0.048322963514919985,"302":0.0015592058012421862,"303":1.4300456835264401,"304":0.010087772315557988,"305":0.002349671436567812,"306":0.06360369283962863,"307":0.0018521344280993286,"308":-1.527349424157024,"309":0.007138815387940021,"310":0.0010875654437706081,"311":-0.0011768891608190937,"312":0.031734153387042816,"313":-0.03001195342100282,"314":0.0009420217023952198,"315":0.05467635072077837,"316":0.06940560860390455,"317":-0.0012801156527980993,"318":0.045278631323028805,"319":-0.0011195837820804223,"320":-0.0106759722992061,"321":-0.04025851452632532,"322":0.00016670842217542798,"323":0.0035913677699630055,"324":-1.2976095274362156,"325":-0.012025777369765641,"326":-1.8445025852508656,"327":-0.007360589850428501,"328":-0.0023120272639714444,"329":-0.0015629787135379325,"330":0.0007551585837044216,"331":0.0034698223513570186,"332":0.02237034913713159,"333":0.14437219119264963,"334":0.1615938168256151,"335":0.004612377266382592,"336":0.0036676694279849636,"337":-1.662203286033956,"338":0.011984442644530413,"339":-0.018539343450423934,"340":-0.0030690767680203726,"341":0.05003843060507458,"342":0.0015415675320689017,"343":1.2630186511624704,"344":0.009990860542947486,"345":0.0023232208062232956,"346":0.06458853634522545,"347":0.0018312144757405072,"348":-1.915130680088906,"349":0.007064131186688152,"350":0.0010752382328969893,"351":-0.0011635537555833154,"352":0.03317436948994802,"353":-0.030015929523544788,"354":0.0009313392002008717,"355":0.05716836348828646,"356":0.07453509635470316,"357":-0.0012656163651021664,"358":0.05323773155921177,"359":-0.0011068950640739524}},"b2":{"n":9,"d":1,"w":{"0":5.506924976256267,"1":5.520820411396625,"2":5.479242922113034,"3":5.572798950528676,"4":5.8731746335861414,"5":5.577770957616541,"6":5.795347152369824,"7":5.377269495293684,"8":5.837126504485458}}}});

    console.log(agent.toJSON());

    this.update = function () {
        environment.update();

        if (tick % interval === 0) {
            if (tick > 0) {
                agent.learn(environment.getReward());
            }
            // activate the neural network
            var action = agent.act(environment.getState());
            environment.performAction(action);

        }
        tick++;
    };

    this.episodeEnd = function () {
        stats.push(environment.getEpisodeStats());

        agent.alpha *= temp_rate;
        agent.epsilon *= temp_rate;

        console.log(agent.alpha, agent.epsilon);

        episode++;
        if (episode === maxEpisodes) {
            console.log('end!!!');
            environment.end();
            downloadObjectAsJson(stats, environment.getName() + '_episode_stats');
            downloadObjectAsJson(agent.toJSON(), environment.getName() + '_brain');
        }
    };

};

function downloadObjectAsJson(exportObj, exportName) {
    var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj));
    var downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", exportName + ".json");
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
}

var Environment = function (game) {
    function getName() {
        return "09-interval-temp-load";
    }

    function getNumStates() {
        return 2;
    }

    function getMaxNumActions() {
        return 9;
    }

    function getState() {
        return [(game.playerX + 2) / 4, game.speed / game.maxSpeed];
    }

    function getReward() {
        return game.speed / game.maxSpeed;
    }

    function performAction(action) {
        // execute agent's desired action
        switch (action) {
            case 0:
                game.keyLeft = false;
                game.keyRight = false;
                game.keyFaster = true;
                game.keySlower = false;
                break;
            case 1:
                game.keyLeft = true;
                game.keyRight = false;
                game.keyFaster = true;
                game.keySlower = false;
                break;
            case 2:
                game.keyLeft = false;
                game.keyRight = true;
                game.keyFaster = true;
                game.keySlower = false;
                break;
            case 3:
                game.keyLeft = false;
                game.keyRight = false;
                game.keyFaster = false;
                game.keySlower = false;
                break;
            case 4:
                game.keyLeft = true;
                game.keyRight = false;
                game.keyFaster = false;
                game.keySlower = false;
                break;
            case 5:
                game.keyLeft = false;
                game.keyRight = true;
                game.keyFaster = false;
                game.keySlower = false;
                break;
            case 6:
                game.keyLeft = false;
                game.keyRight = false;
                game.keyFaster = false;
                game.keySlower = true;
                break;
            case 7:
                game.keyLeft = true;
                game.keyRight = false;
                game.keyFaster = false;
                game.keySlower = true;
                break;
            case 8:
                game.keyLeft = false;
                game.keyRight = true;
                game.keyFaster = false;
                game.keySlower = true;
                break;
        }
    }

    function getEpisodeStats() {
        return game.lastLapTime;
    }


    function update() {
    }

    function end() {
        capturer.stop();
        capturer.save();
    }

    return {
        getNumStates: getNumStates,
        getMaxNumActions: getMaxNumActions,
        getState: getState,
        getReward: getReward,
        performAction: performAction,
        getEpisodeStats: getEpisodeStats,
        update: update,
        end: end,
        getName: getName
    }
};

/*
var environment = new Environment(window);
var agent = new Agent(environment);

var capturer = new CCapture({format: 'webm', framerate: 60, name: environment.getName(), verbose: true});

function render() {
    requestAnimationFrame(render);
    capturer.capture(canvas);
}

setTimeout(function () {
    capturer.start();
    render();
}, 1000);

*/